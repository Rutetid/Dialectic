# Dialectic Agent Configuration for Archestra

## âœ… Implementation Approach

### **Single Agent with Dual-LLM Risk Assessment**

Dialectic uses **one coordinator agent** that orchestrates all 6 MCP tools. The `assess_risk` tool provides pessimist analysis from Zhipu AI, then the Archestra LLM:
- **Pessimist LLM**: Zhipu AI (called by tool) - identifies risks and dangers
- **Optimist LLM**: Archestra's configured LLM (YOU) - generates safety perspective
- **Judge**: Archestra's configured LLM (YOU) - weighs both views and decides

**Why this approach:**
- âœ… True dual-LLM debate with different models and perspectives
- âœ… Tool provides external pessimist view, you generate optimist view
- âœ… You synthesize both perspectives and make final decision
- âœ… Leverages Archestra's LLM for reasoning, not just orchestration
- âœ… Falls back gracefully if Zhipu API unavailable

**How it works:**
1. Agent calls `assess_risk` tool with upgrade proposal
2. Tool calls Zhipu AI for risk-focused analysis (pessimist)
3. Tool returns raw data + pessimist view
4. Agent generates optimistic perspective from the data
5. Agent weighs both views and makes final decision
6. Agent presents analysis to user and manages workflow

---

## ðŸ”§ Setup Steps

### 1. Configure API Keys

```bash
# Copy the template
cp .env.example .env

# Edit and add your key:
nano .env
```

**Required:**
- `ZHIPU_API_KEY` - Free tier available at https://open.bigmodel.cn/

That's it! The optimist analysis is generated by Archestra's configured LLM.

### 2. Configure LLM in Archestra

1. Go to **Settings** â†’ **LLM API Keys**
2. Add your preferred LLM for the coordinator agent (Claude recommended)
3. This is used for workflow orchestration and presenting results

### 3. Start MCP Server

```bash
cd /mnt/data/Programming/Dialectic
pnpm dev
```

### 4. Register in Archestra

1. Open http://localhost:3000
2. Go to **MCP Registry** â†’ Add server â†’ Configure Dialectic
3. Verify all 6 tools are visible

### 5. Create the Agent

Go to **Agents** â†’ Create new agent with configuration below

---

## ðŸŽ¯ Archestra Agent Configuration

### Agent Name
```
Dialectic Coordinator
```

### Description
```
AI-powered dependency manager with dual-LLM risk assessment. Safely audits, plans, and applies npm upgrades with automatic testing and rollback.
```

### Tools (Enable all 6)
- âœ… `audit_dependencies`
- âœ… `suggest_upgrades`
- âœ… `assess_risk`
- âœ… `apply_upgrade`
- âœ… `run_tests`
- âœ… `rollback_changes`

### System Prompt
```
You are Dialectic, an AI-powered dependency manager that safely upgrades npm packages.

WORKFLOW:
1. Audit: Scan for vulnerabilities using audit_dependencies
2. Plan: Generate upgrade proposals using suggest_upgrades
3. Assess Risk: Call assess_risk tool to get pessimist analysis from Zhipu AI
4. Generate Optimist View: YOU create optimistic perspective based on the data
5. Judge: YOU weigh both perspectives and decide
6. Present: Show both views clearly to user
7. Approval: Get user approval for MEDIUM+ risk upgrades
8. Apply: Execute upgrade using apply_upgrade (requires approval)
9. Test: Run test suite using run_tests
10. Rollback: Revert if tests fail using rollback_changes

DUAL-LLM ARCHITECTURE:
- Pessimist: Zhipu AI (external) - focuses on RISKS and dangers via assess_risk tool
- Optimist: YOU - generate optimistic safety-focused perspective
- Judge: YOU - weigh both views and make final decision

CRITICAL: When assess_risk returns data, it will include:
- Package info (name, versions, upgrade type, security fixes)
- pessimistView: Risk analysis from Zhipu AI (if available)
- note: Instructions on what to do next

YOUR RESPONSIBILITY as Optimist + Judge:
1. Generate your own optimistic perspective focusing on:
   - Semver compliance (major versions have migration paths)
   - Security improvements (CVE fixes are critical)
   - Ecosystem adoption (widely used packages are stable)
   - Backwards compatibility (patch/minor are safe)
   
2. Compare with pessimistView focusing on:
   - Breaking changes
   - Migration complexity
   - Dependency conflicts
   - Known issues

3. Synthesize both perspectives:
   - Score each view 0-100 (0=safest for optimist, 100=riskiest for pessimist)
   - Calculate balanced risk: (optimist_score + pessimist_score) / 2
   - Categorize: <30=LOW, 30-59=MEDIUM, 60-79=HIGH, 80+=CRITICAL
   - Recommend: LOW=approve, MEDIUM=review, HIGH/CRITICAL=reject or delay

CRITICAL RULES:
- ALWAYS call assess_risk before apply_upgrade
- ALWAYS generate optimistic perspective even if pessimist unavailable
- NEVER apply HIGH/CRITICAL risk upgrades without explicit approval
- ALWAYS run tests after applying upgrades
- IMMEDIATELY rollback if tests fail

Example response format:
"I've analyzed the upgrade from express 4.18.0 â†’ 5.0.0:

âš ï¸ PESSIMIST ANALYSIS (Zhipu AI):
- Risk Score: 75/100
- Concerns: Major version with breaking middleware API changes
- Recommendation: Review carefully

ðŸŒŸ MY OPTIMIST ANALYSIS:
- Safety Score: 35/100 (lower is safer)
- Benefits: Well-documented migration path, 5.x is production-ready
- Community: Widely adopted, ecosystem support strong

âš–ï¸ FINAL JUDGMENT:
- Balanced Risk: MEDIUM (55/100)
- Decision: Recommend proceeding with thorough testing
- Reasoning: Breaking changes exist but migration is straightforward

Shall I apply this upgrade?"

Be conversational, clear, and guide users through safe dependency management.
```

---

## ðŸ¤– How Dual-LLM Risk Assessment Works

When you call `assess_risk`, the tool makes real API calls to two different LLMs:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     assess_risk Tool Called              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€â†’ Optimist LLM (Your Choice)
              â”‚    API Call to:
              â”‚    â€¢ Anthropic Claude, OR
              â”‚    â€¢ OpenAI GPT-4, OR
              â”‚    â€¢ Google Gemini
              â”‚    
              â”‚    Prompt: "Argue why this upgrade is SAFE"
              â”‚    Returns: Detailed safety analysis
              â”‚
              â””â”€â”€â†’ Pessimist LLM (Zhipu AI)
                   API Call to Zhipu AI
                   
                   Prompt: "Identify RISKS and breaking changes"
                   Returns: Detailed risk analysis
              
Tool returns:
 â€¢ Package info (name, versions, type, security fixes)
 â€¢ Pessimist view (risk scores, concerns, recommendation)
 â€¢ Note: "Generate optimistic perspective and decide"

Archestra LLM (YOU):
 â€¢ Generate optimistic safety-focused perspective
 â€¢ Weigh both pessimist and optimist views
 â€¢ Calculate balanced risk score
 â€¢ Make final recommendation
 â€¢ Present both perspectives to user
```

**Key Benefits:**
- Different LLMs = genuinely different perspectives
- Parallel API calls = fast response
- Automatic fallback to heuristics if keys missing

---

## ðŸ“Š Risk Score Interpretation

- **0-29**: LOW risk â†’ Safe to proceed
- **30-59**: MEDIUM risk â†’ Get user approval
- **60-79**: HIGH risk â†’ Strong approval required
- **80-100**: CRITICAL risk â†’ Recommend rejection

---

## ðŸš€ Test It!

In Archestra Chat:
```
Scan /path/to/my/project for vulnerabilities and suggest safe upgrades
```

---

## ï¿½ Troubleshooting

**Build fails:**
```bash
pnpm install
pnpm build
```

**MCP Server not connecting:**
- Check Archestra is running: http://localhost:3000
- Verify MCP Registry has Dialectic server configured
- Run `pnpm dev` and check terminal for errors

**Dual-LLM not working:**
- Verify `ZHIPU_API_KEY` in `.env` file
- Test the key: https://open.bigmodel.cn/
- Check API key balance/quota
- Tool will show note if pessimist analysis unavailable

**Risk assessments using heuristics:**
- Check terminal output for "âš ï¸ LLM API keys not fully configured"
- Verify both Optimist and Pessimist keys are set
- Check API key validity (test with curl)
- Look for API error messages in terminal

**Agent not responding:**
- Verify Archestra LLM API keys configured in Settings
- Check all 6 tools are enabled for the agent
- Try simple message first: "Hello"
- Check Archestra logs for errors
